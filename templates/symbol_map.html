<!DOCTYPE html>
<html>
<head>
    <title>BiH Mine Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <style>
html, body {
    height: 100%;
    margin: 0;
    padding: 0;
}

#mapid {
    height: 100vh;
    width: 100vw;
}

.leaflet-control-layers {
    background: rgba(255, 255, 255, 0.5);
    padding: 20px; /* Increased padding from 10px to 20px */
    border-radius: 5px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
    text-align: left;
    transform: translateY(100%); /* Center it vertically */
}

.headline {
    font-weight: bold;
    font-size: 12pt;
    color: black;
    margin-bottom: 10px;
    text-align: center;
}

.leaflet-control-layers div {
    display: flex;
    align-items: center;
    margin-bottom: 5px;
}

.leaflet-control-layers label {
    flex: 1;
    display: flex;
    align-items: center;
    font-size: 12pt;
}

.leaflet-control-layers input[type="checkbox"] {
    flex: 0 0 20px;
    margin-right: 10px;
}

.icon-box {
    flex: 0 0 40px;
    height: 40px;
    margin-right: 10px;
    display: flex;
    justify-content: center;
    align-items: center;
}

.icon-suspect, .icon-cleared {
    width: 20px;
    height: 20px;
    background: transparent;
    clip-path: polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 0% 50%);
}

.icon-suspect {
    background: rgba(255, 0, 0, 0.5);
    border: 1px solid red;
}

.icon-cleared {
    background: rgba(0, 0, 255, 0.5);
    border: 1px solid blue;
}

.icon-incidents, .icon-lifted {
    width: 16px; /* Set width and height to the same value to ensure circular shape */
    height: 16px; /* Set width and height to the same value to ensure circular shape */
    border-radius: 50%;
    border: 2px solid; /* Add non-transparent border */
}

.icon-incidents {
    flex-basis: 0;
    margin-right: 20%;
    border-color: orange; /* Border color for incidents */
}

.icon-lifted {
    flex-basis: 0;
    margin-right: 20%;
    border-color: green; /* Border color for lifted minefields */
}

.icon-incidents::before,
.icon-lifted::before {
    content: '';
    width: 16px; /* Adjust size to be smaller */
    height: 16px; /* Adjust size to be smaller */
    border-radius: 50%;
    background: currentColor; /* Use currentColor for background */
    opacity: 0.5; /* Set opacity */
}

.icon-incidents::before {
    background: orange; /* Inner circle background for incidents */
}

.icon-lifted::before {
    background: green; /* Inner circle background for lifted minefields */
}


    </style>
</head>
<body>

    <div id="mapid"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <script>
        var mymap = L.map('mapid').setView([43.8563, 18.4131], 13);
    
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
        }).addTo(mymap);
    
        // Add the search bar
        var geocoder = L.Control.geocoder({
                defaultMarkGeocode: false
            })
        .on('markgeocode', function(e) {
            var latlng = e.geocode.center;
            mymap.setView(latlng, 13); // Change the zoom level if needed
            var marker = L.marker(latlng).addTo(mymap);
    
            // Add an event listener to remove the marker when the map is moved
            mymap.on('move', function() {
                mymap.removeLayer(marker);
            });
        })
        .addTo(mymap);
    
       // Create a variable to hold the GeoJSON layers
   // Create a variable to hold the GeoJSON layers

   var cantonBoundariesLayer;

// Load census data
var censusData = {};

fetch('/static/census.csv')
            .then(response => response.text())
            .then(csvText => {
                var lines = csvText.split('\n');
                lines.forEach(line => {
                    var [location, bosniaks, croats, serbs, other] = line.split(',');
                    location = location.trim();
                    bosniaks = parseFloat(bosniaks.trim());
                    croats = parseFloat(croats.trim());
                    serbs = parseFloat(serbs.trim());
                    other = parseFloat(other.trim());
                    censusData[location] = { bosniaks, croats, serbs, other };
                });
                console.log('Census data loaded:', censusData); // Add log to check loaded data
            });

  // Load canton boundaries GeoJSON and style based on census data
  fetch('/static/cantons.geojson')
            .then(response => response.json())
            .then(data => {
                cantonBoundariesLayer = L.geoJSON(data, {
                    style: function (feature) {
                        var location = feature.properties.shapeName;
                        var majorityGroup = 'Other';
                        if (censusData[location]) {
                            var { bosniaks, croats, serbs, other } = censusData[location];
                            console.log('Processing location:', location, 'Data:', bosniaks, croats, serbs, other); // Log data for each location
                            var maxValue = Math.max(bosniaks, croats, serbs, other);
                            if (maxValue === bosniaks) {
                                majorityGroup = 'Bosniaks';
                            } else if (maxValue === croats) {
                                majorityGroup = 'Croats';
                            } else if (maxValue === serbs) {
                                majorityGroup = 'Serbs';
                            } else if (maxValue === other) {
                                majorityGroup = 'Other';
                            }
                        }

                        var fillColor;
                        if (majorityGroup === 'Bosniaks') {
                            fillColor = 'yellow';
                        } else if (majorityGroup === 'Croats') {
                            fillColor = 'red';
                        } else if (majorityGroup === 'Serbs') {
                            fillColor = 'blue';
                        } else {
                            fillColor = 'gray';
                            
                        }

                        console.log('Location:', location, 'Majority Group:', majorityGroup, 'Fill Color:', fillColor); // Log the final color and majority group

                        return {
                            fillColor: fillColor,
                            fillOpacity: 0.1,
                            color: 'black',
                            weight: 1
                        };
                    }
                });
                cantonBoundariesLayer.addTo(mymap);
            });
var geojsonLayer, clearedAreasLayer, incidentsLayer, liftedMinefieldsLayer, cantonBoundariesLayer;

// Load GeoJSON data
fetch('/static/suspect_areas.geojson')
    .then(response => response.json())
    .then(data => {
        geojsonLayer = L.geoJSON(data, {
            style: function (feature) {
                return {
                    fillColor: 'red',
                    fillOpacity: 0.3,
                    color: 'red',
                    weight: 1
                };
            }
        });
        geojsonLayer.addTo(mymap);  // Only this layer is added initially
    });

// Load cleared_areas.geojson
fetch('/static/cleared_areas.geojson')
    .then(response => response.json())
    .then(data => {
        clearedAreasLayer = L.geoJSON(data, {
            style: function (feature) {
                return {
                    fillColor: 'blue', // Different fill color
                    fillOpacity: 0.3,
                    color: 'blue',
                    weight: 1
                };
            }
        });
        // Do not add to the map initially
    });

// Load incidents.geojson
fetch('/static/incidents.geojson')
    .then(response => response.json())
    .then(data => {
        incidentsLayer = L.geoJSON(data, {
            pointToLayer: function (feature, latlng) {
                // Using L.circle to create a simple circle marker
                return L.circle(latlng, {
                    radius: 50, // Radius in meters; adjust as needed for visibility
                    color: 'orange', // Outline color
                    fillColor: 'orange', // Fill color
                    fillOpacity: 0.5, // Fill opacity
                });
            }
        });
        // Do not add to the map initially
    });

// Load lifted_minefields.geojson
fetch('/static/lifted_minefields.geojson')
    .then(response => response.json())
    .then(data => {
        liftedMinefieldsLayer = L.geoJSON(data, {
            pointToLayer: function (feature, latlng) {
                // Using L.circle to create a simple circle marker
                return L.circle(latlng, {
                    radius: 50, // Radius in meters; adjust as needed for visibility
                    color: 'green', // Outline color
                    fillColor: 'green', // Fill color
                    fillOpacity: 0.5, // Fill opacity
                });
            }
        });
        // Do not add to the map initially
    });

// Modify the custom control to handle all layers
var control = L.control({position: 'topright'});
control.onAdd = function (map) {
    var div = L.DomUtil.create('div', 'leaflet-control-layers');

    // Add the headline
    var headline = L.DomUtil.create('div', 'headline', div);
    headline.innerHTML = 'View various mine-related <br> events';

    // Suspect areas checkbox
    var containerSuspect = L.DomUtil.create('div', 'flex-container', div);
    var checkboxSuspect = L.DomUtil.create('input', '', containerSuspect);
    checkboxSuspect.type = 'checkbox';
    checkboxSuspect.checked = true;  // Only this one is checked initially
    checkboxSuspect.id = 'toggle-geojson-suspect';
    var iconSuspect = L.DomUtil.create('span', 'icon-box icon-suspect', containerSuspect);
    var labelSuspect = L.DomUtil.create('label', 'text-label', containerSuspect);
    labelSuspect.htmlFor = 'toggle-geojson-suspect';
    labelSuspect.appendChild(document.createTextNode('Suspect Areas'));
    checkboxSuspect.onchange = function () {
        if (checkboxSuspect.checked) {
            geojsonLayer.addTo(mymap);
        } else {
            mymap.removeLayer(geojsonLayer);
        }
    };

    // Cleared areas checkbox
    var containerCleared = L.DomUtil.create('div', 'flex-container', div);
    var checkboxCleared = L.DomUtil.create('input', '', containerCleared);
    checkboxCleared.type = 'checkbox';
    checkboxCleared.checked = false;  // Unchecked initially
    checkboxCleared.id = 'toggle-geojson-cleared';
    var iconCleared = L.DomUtil.create('span', 'icon-box icon-cleared', containerCleared);
    var labelCleared = L.DomUtil.create('label', 'text-label', containerCleared);
    labelCleared.htmlFor = 'toggle-geojson-cleared';
    labelCleared.appendChild(document.createTextNode('Cleared Areas'));
    checkboxCleared.onchange = function () {
        if (checkboxCleared.checked) {
            clearedAreasLayer.addTo(mymap);
        } else {
            mymap.removeLayer(clearedAreasLayer);
        }
    };

    // Incidents checkbox
    var containerIncidents = L.DomUtil.create('div', 'flex-container', div);
    var checkboxIncidents = L.DomUtil.create('input', '', containerIncidents);
    checkboxIncidents.type = 'checkbox';
    checkboxIncidents.checked = false;  // Unchecked initially
    checkboxIncidents.id = 'toggle-geojson-incidents';
    var iconIncidents = L.DomUtil.create('span', 'icon-box icon-incidents', containerIncidents);
    var labelIncidents = L.DomUtil.create('label', 'text-label', containerIncidents);
    labelIncidents.htmlFor = 'toggle-geojson-incidents';
    labelIncidents.appendChild(document.createTextNode('Incidents'));
    checkboxIncidents.onchange = function () {
        if (checkboxIncidents.checked) {
            incidentsLayer.addTo(mymap);
        } else {
            mymap.removeLayer(incidentsLayer);
        }
    };

    // Lifted minefields checkbox
    var containerLifted = L.DomUtil.create('div', 'flex-container', div);
    var checkboxLiftedMinefields = L.DomUtil.create('input', '', containerLifted);
    checkboxLiftedMinefields.type = 'checkbox';
    checkboxLiftedMinefields.checked = false;  // Unchecked initially
    checkboxLiftedMinefields.id = 'toggle-geojson-lifted-minefields';
    var iconLiftedMinefields = L.DomUtil.create('span', 'icon-box icon-lifted', containerLifted);
    var labelLiftedMinefields = L.DomUtil.create('label', 'text-label', containerLifted);
    labelLiftedMinefields.htmlFor = 'toggle-geojson-lifted-minefields';
    labelLiftedMinefields.appendChild(document.createTextNode('Lifted Minefields'));
    checkboxLiftedMinefields.onchange = function () {
        if (checkboxLiftedMinefields.checked) {
            liftedMinefieldsLayer.addTo(mymap);
        } else {
            mymap.removeLayer(liftedMinefieldsLayer);
        }
    };

    return div;
};

control.addTo(mymap);

</script>

</body>
</html>